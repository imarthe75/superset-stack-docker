events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    upstream superset {
        server superset:8088;
    }

    upstream prefect {
        server prefect:4200;
    }

    upstream grafana {
        server grafana:3000;
    }

    server {
        listen 80;

        # Superset (Main App)
        location / {
            proxy_pass http://superset;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        # Prefect UI
        # Note: Prefect might need PREFECT_UI_API_URL configured correctly
        # or distinct subdomain usage in production.
        # For simplicity in this stack, we keep it on a separate port or mapped here.
        # Mapping /prefect requires the app to know its base path.
        # If simplicity is key, we might just proxy, but keep distinct ports in docker-compose
        # available for direct access if this fails.
        # Trying path strip:
        location /prefect/ {
            rewrite ^/prefect/(.*) /$1 break;
            proxy_pass http://prefect;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Grafana
        # Requires [server] root_url /grafana/ in grafana.ini or env var
        location /grafana/ {
            rewrite ^/grafana/(.*) /$1 break;
            proxy_pass http://grafana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
