events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    upstream superset {
        server superset:8088;
    }

    upstream prefect {
        server prefect:4200;
    }

    upstream grafana {
        server grafana:3000;
    }

    upstream cube {
        server cube:4000;
    }

    upstream prometheus {
        server prometheus:9090;
    }

    upstream keycloak {
        server keycloak:8080;
    }

    server {
        listen 80;

        # Superset (Main App)
        location / {
            proxy_pass http://superset;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        # Prefect UI
        # Note: Prefect might need PREFECT_UI_API_URL configured correctly
        # or distinct subdomain usage in production.
        # For simplicity in this stack, we keep it on a separate port or mapped here.
        # Mapping /prefect requires the app to know its base path.
        # If simplicity is key, we might just proxy, but keep distinct ports in docker-compose
        # available for direct access if this fails.
        # Trying path strip:
        location /prefect/ {
            rewrite ^/prefect/(.*) /$1 break;
            proxy_pass http://prefect;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Grafana
        location /grafana/ {
            proxy_pass http://grafana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Cube.js API & Playground
        location /cubejs/ {
            proxy_pass http://cube/; # El "/" final elimina el prefijo /cubejs/
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Reescribir rutas absolutas para que pasen por /cubejs/
            sub_filter_once off;
            sub_filter 'href="/' 'href="/cubejs/';
            sub_filter 'src="/' 'src="/cubejs/';
            sub_filter '"/assets/' '"/cubejs/assets/';
            sub_filter '"/playground/' '"/cubejs/playground/';
            sub_filter '"/cubejs-api/' '"/cubejs/cubejs-api/';
            
            # Aplicar a todos los tipos de archivos relevantes (text/html es por defecto)
            sub_filter_types text/css application/javascript;
        }

        # Keycloak
        location /auth/ {
            proxy_pass http://keycloak/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prometheus
        location /prometheus/ {
            # Prometheus needs to know its external URL if behind prefix, 
            # usually configured via --web.external-url. 
            # For simple proxying without config change, we map root or check requirements.
            # Unlike others, Prometheus UI might expect root path unless configured.
            # We will try simple proxy first.
            proxy_pass http://prometheus;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
