events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    resolver 127.0.0.11 valid=30s;

    server {
        listen 80;
        server_name _; # Fallback for any host
        merge_slashes on;

        # Superset (Main App)
        # Redirect root to /tableros/
        location = / {
            return 301 /tableros/;
        }

        # Handle Webpack chunks trying to load from root /static
        location /static/ {
            rewrite ^/static/(.*) /tableros/static/$1 permanent;
        }

        # Handle requests escaping the prefix
        location /superset/ {
            return 301 /tableros$request_uri;
        }

        location /login/ {
            return 301 /tableros$request_uri;
        }

        # Superset (Main App) on /tableros/
        location /tableros/ {
            set $upstream_superset superset:8088;
            proxy_pass http://$upstream_superset;
            proxy_set_header X-Forwarded-Prefix /tableros;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # Disable compression so sub_filter can work
            proxy_set_header Accept-Encoding "";

            # Force prefix on redirects that don't already have it
            proxy_redirect ~^/(?!tableros/)(.*)$ /tableros/$1;

            # Sub_filter to fix links if ProxyFix doesn't catch everything
            sub_filter_once off;
            sub_filter 'src="/static/' 'src="/tableros/static/';
            sub_filter 'href="/static/' 'href="/tableros/static/';
            sub_filter "src='/static/" "src='/tableros/static/";
            sub_filter "href='/static/" "href='/tableros/static/";
            sub_filter '"/static/' '"/tableros/static/';
            sub_filter "'/static/" "'/tableros/static/";
            
            # Use more specific patterns for next to avoid doubling if already prefixed
            sub_filter 'next=/superset' 'next=/tableros/superset';
            sub_filter 'next=%2Fsuperset' 'next=%2Ftableros%2Fsuperset';

            sub_filter 'href="/superset/' 'href="/tableros/superset/';
            sub_filter 'href="/login/' 'href="/tableros/login/';
            sub_filter 'action="/login/' 'action="/tableros/login/';
            sub_filter 'href="/users/' 'href="/tableros/users/';
            sub_filter 'href="/roles/' 'href="/tableros/roles/';
            sub_filter 'href="/rowlevelsecurity/' 'href="/tableros/rowlevelsecurity/';
            sub_filter 'href="/logout/' 'href="/tableros/logout/';
            sub_filter_types text/html application/json application/javascript text/css image/svg+xml;

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            proxy_connect_timeout 300s;
            
            # Disable buffering for better response time on slow connections
            proxy_buffering off;
        }

        # Prefect UI
        location /prefect/ {
            rewrite ^/prefect/(.*) /$1 break;
            set $upstream_prefect prefect:4200;
            proxy_pass http://$upstream_prefect;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Grafana
        location /grafana/ {
            set $upstream_grafana grafana:3000;
            proxy_pass http://$upstream_grafana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Cube.js API & Playground
        location /cubejs/ {
            set $upstream_cube cube:4000;
            proxy_pass http://$upstream_cube/; # El "/" final elimina el prefijo /cubejs/
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Reescribir rutas absolutas para que pasen por /cubejs/
            sub_filter_once off;
            sub_filter 'href="/' 'href="/cubejs/';
            sub_filter 'src="/' 'src="/cubejs/';
            sub_filter '"/assets/' '"/cubejs/assets/';
            sub_filter '"/playground/' '"/cubejs/playground/';
            sub_filter '"/cubejs-api/' '"/cubejs/cubejs-api/';
            
            # Aplicar a todos los tipos de archivos relevantes (text/html es por defecto)
            sub_filter_types text/css application/javascript;
        }

        # Keycloak
        location /auth/ {
            set $upstream_keycloak keycloak:8080;
            proxy_pass http://$upstream_keycloak/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prometheus
        location /prometheus/ {
            set $upstream_prometheus prometheus:9090;
            proxy_pass http://$upstream_prometheus;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # cAdvisor
        location /cadvisor/ {
            set $upstream_cadvisor cadvisor:8080;
            proxy_pass http://$upstream_cadvisor;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            sub_filter_once off;
            sub_filter 'href="/' 'href="/cadvisor/';
            sub_filter 'src="/' 'src="/cadvisor/';
            sub_filter 'action="/' 'action="/cadvisor/';
            sub_filter '"/' '"/cadvisor/';
            
            sub_filter_types text/css application/javascript;
        }
    }
}
