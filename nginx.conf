events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    upstream superset {
        server superset:8088;
    }

    upstream prefect {
        server prefect:4200;
    }

    upstream grafana {
        server grafana:3000;
    }

    upstream cube {
        server cube:4000;
    }

    upstream prometheus {
        server prometheus:9090;
    }

    upstream keycloak {
        server keycloak:8080;
    }

    upstream superset-mcp {
        server superset-mcp:8010;
    }

    upstream cadvisor {
        server cadvisor:8080;
    }

    server {
        listen 80;
        server_name _; # Fallback for any host
        merge_slashes on;

        # Superset (Main App)
        # Redirect root to /tableros/
        location = / {
            return 301 /tableros/;
        }

        # Handle Webpack chunks trying to load from root /static
        location /static/ {
            rewrite ^/static/(.*) /tableros/static/$1 permanent;
        }

        # Handle requests escaping the prefix
        location /superset/ {
            return 301 /tableros$request_uri;
        }

        location /login/ {
            return 301 /tableros$request_uri;
        }

        # Superset (Main App) on /tableros/
        location /tableros/ {
            proxy_pass http://superset;
            proxy_set_header X-Forwarded-Prefix /tableros;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # Sub_filter to fix links if ProxyFix doesn't catch everything
            sub_filter_once off;
            sub_filter 'src="/static/' 'src="/tableros/static/';
            sub_filter 'href="/static/' 'href="/tableros/static/';
            sub_filter 'href="/superset/' 'href="/tableros/superset/';
            sub_filter 'href="/login/' 'href="/tableros/login/';
            sub_filter 'action="/login/' 'action="/tableros/login/';
            sub_filter 'href="/users/' 'href="/tableros/users/';
            sub_filter 'href="/roles/' 'href="/tableros/roles/';
            sub_filter 'href="/rowlevelsecurity/' 'href="/tableros/rowlevelsecurity/';
            sub_filter 'href="/logout/' 'href="/tableros/logout/';
            sub_filter_types text/html application/json;

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            proxy_connect_timeout 300s;
            
            # Disable buffering for better response time on slow connections
            proxy_buffering off;
        }

        # Prefect UI
        # Note: Prefect might need PREFECT_UI_API_URL configured correctly
        # or distinct subdomain usage in production.
        # For simplicity in this stack, we keep it on a separate port or mapped here.
        # Mapping /prefect requires the app to know its base path.
        # If simplicity is key, we might just proxy, but keep distinct ports in docker-compose
        # available for direct access if this fails.
        # Trying path strip:
        location /prefect/ {
            rewrite ^/prefect/(.*) /$1 break;
            proxy_pass http://prefect;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Grafana
        location /grafana/ {
            proxy_pass http://grafana;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Cube.js API & Playground
        location /cubejs/ {
            proxy_pass http://cube/; # El "/" final elimina el prefijo /cubejs/
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Reescribir rutas absolutas para que pasen por /cubejs/
            sub_filter_once off;
            sub_filter 'href="/' 'href="/cubejs/';
            sub_filter 'src="/' 'src="/cubejs/';
            sub_filter '"/assets/' '"/cubejs/assets/';
            sub_filter '"/playground/' '"/cubejs/playground/';
            sub_filter '"/cubejs-api/' '"/cubejs/cubejs-api/';
            
            # Aplicar a todos los tipos de archivos relevantes (text/html es por defecto)
            sub_filter_types text/css application/javascript;
        }

        # Keycloak
        location /auth/ {
            proxy_pass http://keycloak/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Prometheus
        location /prometheus/ {
            # Prometheus needs to know its external URL if behind prefix, 
            # usually configured via --web.external-url. 
            # For simple proxying without config change, we map root or check requirements.
            # Unlike others, Prometheus UI might expect root path unless configured.
            # We will try simple proxy first.
            proxy_pass http://prometheus;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Superset MCP (SSE)
        location /mcp/ {
            proxy_pass http://superset-mcp/;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_cache off;
            proxy_buffering off;
            proxy_read_timeout 24h;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # cAdvisor
        location /cadvisor/ {
            proxy_pass http://cadvisor;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Rewrite redirects/links if cAdvisor assumes root path
            sub_filter_once off;
            sub_filter 'href="/' 'href="/cadvisor/';
            sub_filter 'src="/' 'src="/cadvisor/';
            sub_filter 'action="/' 'action="/cadvisor/';
            # Fix for AJAX/JS calls that might use absolute paths
            sub_filter '"/' '"/cadvisor/';
            
            sub_filter_types text/css application/javascript;
        }
    }
}
