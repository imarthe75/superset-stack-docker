groups:
  - name: Critical_Alerts
    rules:
      - alert: PostgresHighLatency
        expr: pg_stat_activity_max_tx_duration > 1 # Placeholder, assuming seconds. Adjust based on available metric.
        # Alternative standard metric: rate(pg_stat_database_xact_commit[5m]) or similar if query time histogram is not available.
        # Better approximation if histogram available: histogram_quantile(0.99, rate(pg_stat_database_query_duration_seconds_bucket[5m])) > 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL Latency High"
          description: "P99 Latency exceeds 1000ms"

      - alert: CubeCacheHitLow
        # Assuming metric cubejs_cache_hits_total and cubejs_cache_misses_total exist
        expr: (rate(cubejs_cache_events_total{type="hit"}[5m]) / (rate(cubejs_cache_events_total{type="hit"}[5m]) + rate(cubejs_cache_events_total{type="miss"}[5m]))) * 100 < 80
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Cube.js Cache Hit Rate Low"
          description: "Cache hit rate is below 80%."

      - alert: PrefectWorkerIdle
        # Assuming metric prefect_flow_run_success_total or similar
        expr: increase(prefect_flow_runs_count{state="COMPLETED"}[24h]) == 0
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "Prefect Pipeline Stalled"
          description: "No successful tasks reported in the last 24 hours."
